#nextcloud installation https://techguides.yt/guides/how-to-install-and-configure-nextcloud-hub-21/
sudo apt update
sudo apt install apache2 mysql-server
sudo mysql_secure_installation
sudo mysql -u root -p
mysql> create database nextcloud;
mysql> create user 'nextcloud'@'localhost' identified by 'PASSWORD';
mysql> grant all privileges on nextcloud.* to 'nextcloud'@'localhost';
mysql> flush privileges;
mysql> quit
sudo apt install php7.4 php7.4-gd php7.4-mysql php7.4-curl php7.4-mbstring php7.4-intl php7.4-gmp php7.4-bcmath php7.4-xml libapache2-mod-php7.4 php7.4-zip php-imagick php-apcu
wget https://download.nextcloud.com/server/releases/nextcloud-21.0.2.zip
sudo unzip nextcloud-21.0.2.zip -d /var/www
cd /var/www
sudo chown -R www-data:www-data nextcloud/
sudo a2enmod headers env dir mime rewrite
sudo service apache2 restart
sudo nano /etc/apache2/sites-available/000-default.conf
<VirtualHost *:80>

    ServerName cloud.yourdomain.com
    DocumentRoot /var/www/nextcloud

    <Directory /var/www/nextcloud/>
        Require all granted
        AllowOverride All
        Options FollowSymLinks MultiViews

        <IfModule mod_dav.c>
            Dav off
        </IfModule>

        RewriteEngine On
        RewriteRule ^/\.well-known/carddav https://%{SERVER_NAME}/remote.php/dav/ [R=301,L]
        RewriteRule ^/\.well-known/caldav https://%{SERVER_NAME}/remote.php/dav/ [R=301,L]
        RewriteRule ^/\.well-known/host-meta https://%{SERVER_NAME}/public.php?service=host-meta [QSA,L]
        RewriteRule ^/\.well-known/host-meta\.json https://%{SERVER_NAME}/public.php?service=host-meta-json [QSA,L]
        RewriteRule ^/\.well-known/webfinger https://%{SERVER_NAME}/public.php?service=webfinger [QSA,L]

    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

</VirtualHost>
sudo service apache2 restart
sudo nano /var/www/nextcloud/config/config.php
'default_phone_region' => 'IN',
'memcache.local' => '\OC\Memcache\APCu',
'trusted_domains' => 
array(
  0 => 192.168.1.50:80
  1 => http://yourdomain.com
),
'datadirectory' => '/mnt/cloud/data',
sudo nano /etc/php/7.4/config.php
memory_limit = 512M
sudo crontab -u www-data -e
*/5  *  *  *  * php -f /var/www/nextcloud/cron.php
sudo apt remove imagemagick-6-common php-imagick
sudo apt autoremove
sudo apt install imagemagick php-imagick
sudo cp -a /var/www/nextcloud/data/. /mnt/cloud/data/
sudo -u www-data php /var/www/nextcloud/occ maintenance:update:htaccess
#ssl certification https://techguides.yt/guides/free-wildcard-ssl-certificate-for-nextcloud-and-wordpress/
sudo apt-get update
sudo apt-get install software-properties-common
sudo add-apt-repository universe
sudo add-apt-repository ppa:certbot/certbot
sudo apt-get update
sudo apt-get install certbot python-certbot-apache
sudo certbot certonly --manual -d *.yourdomain.com -d yourdomain.com --agree-tos --no-bootstrap --manual-public-ip-logging-ok --preferred-challenges dns-01 --server https://acme-v02.api.letsencrypt.org/directory
sudo nano /etc/apache2/sites-available/default-ssl.conf
<VirtualHost *:443>
        ServerName yourdomain.com
        SSLEngine On
        SSLCertificateFile /etc/letsencrypt/live/yourdomain.com/cert.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/yourdomain.com/privkey.pem
        DocumentRoot /var/www/html/
        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
sudo a2ensite default-ssl.conf
sudo a2enmod ssl
sudo a2enmod rewrite
sudo service apache2 restart
